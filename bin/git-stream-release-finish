#!/usr/bin/env bash

gitstream_release_finish() {
    local version prefixed_version branch merge_args

    if [ $# -ne 1 ]; then
        usage; exit 1;
    fi

    version="$1"

    if [ ${version:0:${#VERSION_PREFIX}} = ${VERSION_PREFIX} ]; then
        prefixed_version="${version}"
    else
        prefixed_version="${VERSION_PREFIX}${version}"
    fi

    branch="${RELEASE_PREFIX}${prefixed_version}"

    if git_rev_exists ${prefixed_version}; then
        print_error echo "Tag ${prefixed_version} already exists"
        exit 1
    fi

    if [ ${GITSTREAM_RELEASE_NOFF} -eq 1 ] || [ ${#GITSTREAM_RELEASE_MESSAGE} -gt 0 ]; then
        merge_args="${merge_args} --no-ff"
    fi

    if [ ${#GITSTREAM_RELEASE_MESSAGE} -gt 0 ]; then
        merge_args="${merge_args} -m ${GITSTREAM_RELEASE_MESSAGE}"
    fi

    gitstream_merge "${branch}" "${WORKING_BRANCH}" ${merge_args}

    if ! do_git branch -d ${branch}; then
        print_error echo "Failed to remove ${branch}"
        exit 1
    fi

    if ! do_git tag ${prefixed_version}; then
        print_error echo "Failed to create tag ${prefixed_version}"
        exit 1
    fi

    echo
    echo "Release ${version} has been merged into ${WORKING_BRANCH} and a tag made"
}